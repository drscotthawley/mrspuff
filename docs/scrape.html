---

title: scrape


keywords: fastai
sidebar: home_sidebar

summary: "This is a collection of routines for dataset-building via web scraping, intended to be run on Google Colab"
description: "This is a collection of routines for dataset-building via web scraping, intended to be run on Google Colab"
nb_path: "scrape.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: scrape.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is modified from Google-scraping code first shared <a href="https://forums.fast.ai/t/google-image-scraper/79682/6">by akashgshastri on Fast.ai forums</a> which I then updated.</p>
<p><em>Note: Turns out that Jeremy Howard &amp; Sylvain Gugger had already taught scraping in the <a href="https://github.com/fastai/course2020">2020 version of the FastAI course</a>, and provided some useful routines. So, the code I'd had written previously, I'm going to remove and replace with slighly modified versions of theirs.  (In particular, their DuckDuckGo scraper doesn't require any Selenium ChromeDriver like the Google-scraping code I'd written. Which is great because that was messing up the CI on GitHub anyway.)</em></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="search_images_ddg" class="doc_header"><code>search_images_ddg</code><a href="https://github.com/drscotthawley/mrspuff/tree/master/mrspuff/scrape.py#L30" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>search_images_ddg</code>(<strong><code>key</code></strong>, <strong><code>max_n</code></strong>=<em><code>200</code></em>)</p>
</blockquote>
<p>By Howard &amp; Gugger: Search for 'key' with DuckDuckGo and return a unique urls of 'max_n' images
(Adopted from <a href="https://github.com/deepanprabhu/duckduckgo-images-api">https://github.com/deepanprabhu/duckduckgo-images-api</a>)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="download_and_save" class="doc_header"><code>download_and_save</code><a href="https://github.com/drscotthawley/mrspuff/tree/master/mrspuff/scrape.py#L57" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>download_and_save</code>(<strong><code>folder_path</code></strong>:<code>str</code>, <strong><code>url</code></strong>:<code>str</code>, <strong><code>verbose</code></strong>:<code>bool</code>=<em><code>True</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="search_and_download" class="doc_header"><code>search_and_download</code><a href="https://github.com/drscotthawley/mrspuff/tree/master/mrspuff/scrape.py#L79" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>search_and_download</code>(<strong><code>search_term</code></strong>:<code>str</code>, <strong><code>df</code></strong>=<em><code>None</code></em>, <strong><code>target_path</code></strong>:<code>str</code>=<em><code>'./images'</code></em>, <strong><code>num_images</code></strong>:<code>int</code>=<em><code>10</code></em>, <strong><code>verbose</code></strong>:<code>bool</code>=<em><code>True</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="img_scrape" class="doc_header"><code>img_scrape</code><a href="https://github.com/drscotthawley/mrspuff/tree/master/mrspuff/scrape.py#L100" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>img_scrape</code>(<strong><code>search_terms</code></strong>:<code>list</code>, <strong><code>target_path</code></strong>:<code>str</code>=<em><code>'./.images'</code></em>, <strong><code>num_images</code></strong>:<code>int</code>=<em><code>10</code></em>, <strong><code>verbose</code></strong>:<code>bool</code>=<em><code>True</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">### Variables to adjust</span>

<span class="sd">1. set search_term to an array of strings for which you want images</span>
<span class="sd">2. set num_images to the number of images you want for each class</span>
<span class="sd">3. set target_path to the path where you want images dataset created.</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">search_terms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span><span class="s1">&#39;dog&#39;</span><span class="p">,</span><span class="s1">&#39;horse&#39;</span><span class="p">]</span>                    
<span class="c1">#search_terms = [&quot;les paul guitar&quot;, &quot;stratocaster guitar&quot;] # H/T Nathan Sepulveda</span>
<span class="c1">#search_terms = [&quot;alligator&quot;, &quot;crocodile&quot;]                 # tricky</span>
<span class="c1">#search_terms = [&quot;blue sky&quot;, &quot;stop sign&quot;]                  # easy: these separate by color!</span>
<span class="c1">#search_terms = [&quot;smart person&quot;, &quot;stupid person&quot;]          # this is going to be a bad idea! (ethics)</span>

<span class="n">num_images</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">target_dir</span> <span class="o">=</span> <span class="s1">&#39;scraped_images&#39;</span>            <span class="c1"># where to save to</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">img_scrape</span><span class="p">(</span><span class="n">search_terms</span><span class="p">,</span> <span class="n">target_path</span><span class="o">=</span><span class="n">target_dir</span><span class="p">,</span> <span class="n">num_images</span><span class="o">=</span><span class="n">num_images</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span><span class="s2">&quot;images&quot;</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's see what's been saved to disk:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>ls <span class="o">{</span>target_dir<span class="o">}</span>/*
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we should probably inspect the data to see if it looks good or if we accidentally grabbed images we don't want.</p>
<h3 id="Extra:-Interactive-Image-Browser-(Slider)">Extra: Interactive Image Browser (Slider)<a class="anchor-link" href="#Extra:-Interactive-Image-Browser-(Slider)"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Category</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urls</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ni</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">urls</span><span class="p">)</span>
        <span class="c1">#assert ni==nu</span>
        <span class="k">return</span> <span class="n">ni</span>

<span class="c1"># Load images from disk</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">Category</span><span class="p">()</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">search_terms</span><span class="p">}</span>
<span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">search_terms</span><span class="p">:</span>
    <span class="nb">dir</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>  <span class="c1"># spaces to underscores for disk access</span>
    <span class="nb">dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target_dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">dir</span><span class="si">}</span><span class="s1">/&#39;</span>
    <span class="n">dataset</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">dir</span><span class="si">}</span><span class="s1">*.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;jpg&quot;</span><span class="p">,</span><span class="s2">&quot;gif&quot;</span><span class="p">,</span><span class="s2">&quot;png&quot;</span><span class="p">,</span><span class="s2">&quot;tga&quot;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">.</span><span class="n">images</span><span class="p">)</span><span class="si">}</span><span class="s1"> images for </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="browse_images" class="doc_header"><code>browse_images</code><a href="https://github.com/drscotthawley/mrspuff/tree/master/mrspuff/scrape.py#L115" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>browse_images</code>(<strong><code>dataset</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">browse_images</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's make a bunch of thumbnails. So, for every file in target_path, load the image, shrink it, and save it to a similar filename in a similar directory structure</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_thumb_urls" class="doc_header"><code>get_thumb_urls</code><a href="https://github.com/drscotthawley/mrspuff/tree/master/mrspuff/scrape.py#L127" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_thumb_urls</code>(<strong><code>image_paths</code></strong>=<em><code>None</code></em>, <strong><code>images_dir</code></strong>:<code>str</code>=<em><code>'scraped_images'</code></em>, <strong><code>size</code></strong>:<code>tuple</code>=<em><code>(224, 224)</code></em>, <strong><code>verbose</code></strong>:<code>bool</code>=<em><code>False</code></em>)</p>
</blockquote>
<p>This will save thumbnails of images and provide 'hosted' urls to them if on Colab</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">urls</span> <span class="o">=</span> <span class="n">get_thumb_urls</span><span class="p">(</span><span class="n">target_dir</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;urls = &quot;</span><span class="p">,</span><span class="n">urls</span><span class="p">)</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">urls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">IN_COLAB</span> <span class="k">else</span> <span class="s1">&#39;https://drive.google.com/uc?id=1owIYMyW7yaYlZ4QcJ8P3iIxkl_mCN-GX&#39;</span>
<span class="n">HTML</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;img src=</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&gt;&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="exhibit_urls" class="doc_header"><code>exhibit_urls</code><a href="https://github.com/drscotthawley/mrspuff/tree/master/mrspuff/scrape.py#L189" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>exhibit_urls</code>(<strong><code>targ</code></strong>, <strong><code>labels</code></strong>=<em><code>['cat', 'dog', 'horse']</code></em>)</p>
</blockquote>
<p>grabs a set of urls, in order of images that match the labels corresponding to targets</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">prob</span><span class="p">,</span> <span class="n">targ</span> <span class="o">=</span> <span class="n">calc_prob</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="n">urls</span> <span class="o">=</span> <span class="n">exhibit_urls</span><span class="p">(</span><span class="n">targ</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span><span class="s1">&#39;dog&#39;</span><span class="p">,</span><span class="s1">&#39;horse&#39;</span><span class="p">])</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">targ</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

