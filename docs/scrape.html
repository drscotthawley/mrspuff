---

title: scrape


keywords: fastai
sidebar: home_sidebar

summary: "This is a collection of routines for dataset-building via web scraping"
description: "This is a collection of routines for dataset-building via web scraping"
nb_path: "03_scrape.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 03_scrape.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This was first shared by <a href="https://forums.fast.ai/t/google-image-scraper/79682/6">akashgshastri on Fast.ai forums</a>, which I've updated for Colab,</p>
<p>...and added some tools to visualize the dataset after it's scraped.   -- Scott Hawley</p>
<h2 id="You-want-to-install-Kora">You want to install Kora<a class="anchor-link" href="#You-want-to-install-Kora"> </a></h2><p><a href="https://pypi.org/project/kora">kora</a> for Colab gives you Selenium, Bokeh &amp; much more!:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#from kora.selenium import wd</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">kora.selenium</span> <span class="kn">import</span> <span class="n">wd</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">subprocess</span> 
    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;pip&quot;</span><span class="p">,</span> <span class="s2">&quot;install&quot;</span><span class="p">,</span> <span class="s2">&quot;kora&quot;</span><span class="p">])</span>
    <span class="kn">from</span> <span class="nn">kora.selenium</span> <span class="kn">import</span> <span class="n">wd</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="And-now-to-the-scraping...">And now to the scraping...<a class="anchor-link" href="#And-now-to-the-scraping..."> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">fetch_image_urls</span><span class="p">(</span><span class="n">query</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">max_links_to_fetch</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">wd</span><span class="p">:</span><span class="n">wd</span><span class="p">,</span> <span class="n">sleep_between_interactions</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">scroll_to_end</span><span class="p">(</span><span class="n">wd_old</span><span class="p">):</span>
        <span class="n">wd</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span><span class="s2">&quot;window.scrollTo(0, document.body.scrollHeight);&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_between_interactions</span><span class="p">)</span>    
    
    <span class="c1"># build the google query</span>
    <span class="n">search_url</span> <span class="o">=</span> <span class="s2">&quot;https://www.google.com/search?safe=off&amp;site=&amp;tbm=isch&amp;source=hp&amp;q=</span><span class="si">{q}</span><span class="s2">&amp;oq=</span><span class="si">{q}</span><span class="s2">&amp;gs_l=img&quot;</span>

    <span class="c1"># load the page</span>
    <span class="n">wd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">search_url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">query</span><span class="p">))</span>

    <span class="n">image_urls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">image_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">results_start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">image_count</span> <span class="o">&lt;</span> <span class="n">max_links_to_fetch</span><span class="p">:</span>
        <span class="n">scroll_to_end</span><span class="p">(</span><span class="n">wd</span><span class="p">)</span>

        <span class="c1"># get all image thumbnail results</span>
        <span class="n">thumbnail_results</span> <span class="o">=</span> <span class="n">wd</span><span class="o">.</span><span class="n">find_elements_by_css_selector</span><span class="p">(</span><span class="s2">&quot;img.Q4LuWd&quot;</span><span class="p">)</span>
        <span class="n">number_results</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">thumbnail_results</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">: Found: </span><span class="si">{</span><span class="n">number_results</span><span class="si">}</span><span class="s2"> search results. Extracting links from </span><span class="si">{</span><span class="n">results_start</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">number_results</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">thumbnail_results</span><span class="p">[</span><span class="n">results_start</span><span class="p">:</span><span class="n">number_results</span><span class="p">]:</span>
            <span class="c1"># try to click every thumbnail such that we can get the real image behind it</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">img</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_between_interactions</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># extract image urls    </span>
            <span class="n">actual_images</span> <span class="o">=</span> <span class="n">wd</span><span class="o">.</span><span class="n">find_elements_by_css_selector</span><span class="p">(</span><span class="s1">&#39;img.n3VNCb&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">actual_image</span> <span class="ow">in</span> <span class="n">actual_images</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">actual_image</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;http&#39;</span> <span class="ow">in</span> <span class="n">actual_image</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">):</span>
                    <span class="n">image_urls</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">actual_image</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">))</span>

            <span class="n">image_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_urls</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_urls</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max_links_to_fetch</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">: Found: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">image_urls</span><span class="p">)</span><span class="si">}</span><span class="s2"> image links, done!&quot;</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">: Found:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_urls</span><span class="p">),</span> <span class="s2">&quot;image links, looking for more ...&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
            <span class="k">return</span>
            <span class="n">load_more_button</span> <span class="o">=</span> <span class="n">wd</span><span class="o">.</span><span class="n">find_element_by_css_selector</span><span class="p">(</span><span class="s2">&quot;.mye4qd&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">load_more_button</span><span class="p">:</span>
                <span class="n">wd</span><span class="o">.</span><span class="n">execute_script</span><span class="p">(</span><span class="s2">&quot;document.querySelector(&#39;.mye4qd&#39;).click();&quot;</span><span class="p">)</span>

        <span class="c1"># move the result startpoint further down</span>
        <span class="n">results_start</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">thumbnail_results</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">image_urls</span>


<span class="k">def</span> <span class="nf">download_and_save</span><span class="p">(</span><span class="n">folder_path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">image_content</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR - Could not download </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">try</span><span class="p">:</span>
        <span class="n">image_file</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">image_content</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">image_content</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;JPEG&quot;</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="mi">85</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SUCCESS - saved </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> - as </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR - Could not save </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">success</span>
    

<span class="k">def</span> <span class="nf">search_and_download</span><span class="p">(</span><span class="n">search_term</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">target_path</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;./images&#39;</span><span class="p">,</span> <span class="n">number_images</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    
    <span class="n">target_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">search_term</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target_folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">target_folder</span><span class="p">)</span>

    <span class="n">try_urls</span> <span class="o">=</span> <span class="n">fetch_image_urls</span><span class="p">(</span><span class="n">search_term</span><span class="p">,</span> <span class="n">number_images</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="n">wd</span><span class="p">,</span> <span class="n">sleep_between_interactions</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">count</span><span class="p">,</span> <span class="n">urls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]</span>      <span class="c1"># save count of success and urls whose images were successfully saved</span>
    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">try_urls</span><span class="p">:</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">download_and_save</span><span class="p">(</span><span class="n">target_folder</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rc</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">search_term</span><span class="si">}</span><span class="s2">: Expected </span><span class="si">{</span><span class="n">number_images</span><span class="si">}</span><span class="s2">, succeeded at saving </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">count</span><span class="p">,</span> <span class="n">urls</span> 


<span class="c1"># work inprogress</span>
<span class="k">class</span> <span class="nc">Category</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urls</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ni</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">urls</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ni</span><span class="o">==</span><span class="n">nu</span> 
        <span class="k">return</span> <span class="n">ni</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="img_scrape" class="doc_header"><code>img_scrape</code><a href="https://github.com/drscotthawley/mrspuff/tree/master/mrspuff/scrape.py#L13" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>img_scrape</code>(<strong><code>search_terms</code></strong>:<code>list</code>, <strong><code>target_path</code></strong>:<code>str</code>=<em><code>'./images'</code></em>, <strong><code>number_images</code></strong>:<code>int</code>=<em><code>10</code></em>, <strong><code>verbose</code></strong>:<code>bool</code>=<em><code>True</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">### Variables to adjust</span>

<span class="sd">1. set search_term to an array of strings for which you want images</span>
<span class="sd">2. set number_images to the number of images you want for each class</span>
<span class="sd">3. set target_path to the path where you want images dataset created.</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="n">search_terms</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dog&quot;</span><span class="p">,</span> <span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="s2">&quot;horse&quot;</span><span class="p">]</span>                     <span class="c1"># the usual</span>
<span class="c1">#search_terms = [&quot;les paul guitar&quot;, &quot;stratocaster guitar&quot;] # H/T Nathan Sepulveda</span>
<span class="c1">#search_terms = [&quot;alligator&quot;, &quot;crocodile&quot;]                 # tricky</span>
<span class="c1">#search_terms = [&quot;blue sky&quot;, &quot;stop sign&quot;]                  # easy: these separate by color!</span>
<span class="c1">#search_terms = [&quot;smart person&quot;, &quot;stupid person&quot;]          # this is going to be a bad idea! (ethics)</span>

<span class="n">number_images</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">target_path</span> <span class="o">=</span> <span class="s1">&#39;./images&#39;</span>            <span class="c1"># where to save to</span>

<span class="o">!</span>rm -rf <span class="nv">$target_path</span>                # clear out target_path first

<span class="c1"># grab everything! </span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">img_scrape</span><span class="p">(</span><span class="n">search_terms</span><span class="p">,</span> <span class="n">target_path</span><span class="o">=</span><span class="n">target_path</span><span class="p">,</span> <span class="n">number_images</span><span class="o">=</span><span class="n">number_images</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>
dog: Found: 100 search results. Extracting links from 0:100
dog: Found: 10 image links, done!
SUCCESS - saved https://images.theconversation.com/files/319375/original/file-20200309-118956-1cqvm6j.jpg?ixlib=rb-1.1.0&amp;q=45&amp;auto=format&amp;w=1200&amp;h=900.0&amp;fit=crop - as ./images/dog/3a9e97b232.jpg
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's see what's been saved to disk:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>ls ./images/*
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we should probably inspect the data to see if it looks good or if we accidentally grabbed images we don't want.</p>
<h3 id="Extra:-Interactive-Image-Browser-(Slider)">Extra: Interactive Image Browser (Slider)<a class="anchor-link" href="#Extra:-Interactive-Image-Browser-(Slider)"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interact</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="kn">import</span> <span class="nn">glob</span>

<span class="c1"># Load images from disk</span>
<span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">search_terms</span><span class="p">:</span>
    <span class="nb">dir</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>  <span class="c1"># spaces to underscores for disk access</span>
    <span class="nb">dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target_path</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">dir</span><span class="si">}</span><span class="s1">/&#39;</span>
    <span class="n">dataset</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">dir</span><span class="si">}</span><span class="s1">*.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;jpg&quot;</span><span class="p">,</span><span class="s2">&quot;gif&quot;</span><span class="p">,</span><span class="s2">&quot;png&quot;</span><span class="p">,</span><span class="s2">&quot;tga&quot;</span><span class="p">]]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">.</span><span class="n">images</span><span class="p">)</span><span class="si">}</span><span class="s1"> images for </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">browse_images</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Select the class from the drop-down, and the image by moving the slider with the mouse or the arrow keys.&quot;</span><span class="p">)</span>
    <span class="nd">@interact</span><span class="p">(</span><span class="n">term</span><span class="o">=</span><span class="n">search_terms</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_browse_images</span><span class="p">(</span><span class="n">term</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">term</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">view_image</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray_r</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">interact</span><span class="p">(</span><span class="n">view_image</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<span class="n">browse_images</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Extra:-Hover-over-points-and-see-images">Extra: Hover over points and see images<a class="anchor-link" href="#Extra:-Hover-over-points-and-see-images"> </a></h3><p>Using <a href="https://pypi.org/project/kora/">kora</a> &amp; <a href="https://docs.bokeh.org/en/latest/docs/user_guide/tools.html#custom-tooltip">Bokeh</a>.</p>
<p>TODO: Issue is that we have to load images <em>again</em> from the <em>original image URLs</em> in order for this to work. ...this is gonna be amazingly slow, we should use thumbnails somehow.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">kora.bokeh</span> <span class="kn">import</span> <span class="n">figure</span>
<span class="kn">from</span> <span class="nn">bokeh.plotting</span> <span class="kn">import</span> <span class="n">ColumnDataSource</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">show</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">linalg</span> <span class="k">as</span> <span class="n">LA</span>

<span class="c1"># We&#39;ll use PCA to get x &amp; y coordinates at which to plot data points</span>
<span class="c1">#  For that, we need to crop/resize the images to make a uniform array shape</span>
<span class="c1">#  Note, for now we&#39;re not cropping, so the resize skews the images!</span>
<span class="k">def</span> <span class="nf">get_pca_xy</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">sorted_eig</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>  <span class="c1"># returns sorted eigenvalues (&amp; their corresponding eignevectors) of A</span>
        <span class="n">lambdas</span><span class="p">,</span> <span class="n">vecs</span> <span class="o">=</span> <span class="n">LA</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="c1"># Next line just sorts values &amp; vectors together in order of decreasing eigenvalues</span>
        <span class="n">lambdas</span><span class="p">,</span> <span class="n">vecs</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">lambdas</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">vecs</span><span class="o">.</span><span class="n">T</span><span class="p">)),</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">lambdas</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vecs</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># un-doing the list-casting from the previous line</span>

    <span class="c1"># In the next line, try putting &quot;ImageOps.grayscale( )&quot; around the &quot;img&quot; in front of the &quot;.resize&quot; ;-) </span>
    <span class="n">imlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span> <span class="n">img</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">ANTIALIAS</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># resize to tiny, then flatten to 1D</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">search_terms</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">.</span><span class="n">images</span><span class="p">]</span>
    <span class="n">images_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">imlist</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;images_array.shape = &quot;</span><span class="p">,</span><span class="n">images_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">im_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">images_array</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>   <span class="c1"># get covariance matrix</span>
    <span class="n">lambdas</span><span class="p">,</span> <span class="n">vecs</span> <span class="o">=</span> <span class="n">sorted_eig</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">im_cov</span><span class="p">))</span>  <span class="c1"># get the eigenvectors</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">vecs</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>                      <span class="c1"># Grab the 2 most significant dimensions</span>
    <span class="n">proj_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">images_array</span> <span class="o">@</span> <span class="n">W</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c1"># Last step of PCA: projection </span>

    <span class="n">xs</span><span class="o">=</span><span class="n">proj_img</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># this is for both classes together as one long array</span>
    <span class="n">ys</span><span class="o">=</span><span class="n">proj_img</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> 


<span class="k">def</span> <span class="nf">plot_hover</span><span class="p">(</span><span class="n">dataset</span><span class="p">):</span>
    <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">get_pca_xy</span><span class="p">()</span>

    <span class="n">output_file</span><span class="p">(</span><span class="s2">&quot;toolbar.html&quot;</span><span class="p">)</span>

    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span><span class="s2">&quot;red&quot;</span><span class="p">,</span><span class="s2">&quot;green&quot;</span><span class="p">]</span>

    <span class="n">TOOLTIPS</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;div&gt;</span>
<span class="s2">            &lt;div&gt;</span>
<span class="s2">                &lt;img</span>
<span class="s2">                    src=&quot;@imgs&quot; height=&quot;50&quot; alt=&quot;@imgs&quot; </span>
<span class="s2">                    style=&quot;float: left; margin: 0px 15px 15px 0px;&quot;</span>
<span class="s2">                    border=&quot;2&quot;</span>
<span class="s2">                &gt;&lt;/img&gt;</span>
<span class="s2">            &lt;/div&gt;</span>
<span class="s2">            &lt;div&gt;</span>
<span class="s2">                &lt;span style=&quot;font-size: 17px; font-weight: bold;&quot;&gt;@desc&lt;/span&gt;</span>
<span class="s2">                &lt;span style=&quot;font-size: 15px; color: #966;&quot;&gt;[$index]&lt;/span&gt;</span>
<span class="s2">            &lt;/div&gt;</span>
<span class="s2">            &lt;!---commenting-out coordinate values &lt;div&gt;</span>
<span class="s2">                &lt;span style=&quot;font-size: 10px; color: #696;&quot;&gt;($x, $y)&lt;/span&gt;</span>
<span class="s2">            &lt;/div&gt; --&gt;</span>
<span class="s2">        &lt;/div&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span><span class="mi">400</span><span class="p">,</span>  <span class="n">tooltips</span><span class="o">=</span><span class="n">TOOLTIPS</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Mouse over the dots&quot;</span><span class="p">)</span>

    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># where to read from x &amp; y arrays</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">search_terms</span><span class="p">):</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">.</span><span class="n">urls</span><span class="p">)</span>  <span class="c1"># TODO: stop using full image urls, better to use thumbnails</span>

        <span class="c1">#x, y = np.random.rand(n)+i/2, np.random.rand(n) # just random points for now</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span>  <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">n</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">n</span><span class="p">]</span>

        <span class="n">source</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span> <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> 
            <span class="n">imgs</span><span class="o">=</span><span class="n">dataset</span><span class="p">[</span><span class="n">term</span><span class="p">]</span><span class="o">.</span><span class="n">urls</span><span class="p">)</span> <span class="p">)</span>

        <span class="n">p</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fill_color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">+=</span> <span class="n">n</span> 

    <span class="c1">#show(p)</span>
    <span class="k">return</span> <span class="n">p</span>
    
<span class="n">plot_hover</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

